<div id="grid-top"></div>

<p>
<code>msh</code> provides a high-performance columnar data frame type called <strong>Grid</strong>, inspired by pandas and Axon grids.
Grids are ideal for working with tabular data, time series analysis, and data transformation pipelines.
</p>

<ul>
    <li><a href="#grid-overview">Overview</a></li>
    <li><a href="#grid-literal-syntax">Literal Syntax</a></li>
    <li><a href="#grid-metadata">Metadata</a></li>
    <li><a href="#grid-operations">Grid Operations</a></li>
    <li><a href="#grid-view">GridView</a></li>
    <li><a href="#grid-row">GridRow</a></li>
    <li><a href="#grid-iteration">Iteration Operations</a></li>
</ul>

<h1 id="grid-overview">Overview <a class="section-link" href="#grid-overview" aria-label="Permalink">§</a> <a class="back-to-top" href="#grid-top">Back to top</a></h1>

<p>
A Grid stores data in columnar format, where each column is stored as a contiguous array.
This provides excellent cache locality for column-wise operations like aggregations, filtering, and transformations.
</p>

<p>
Grids support:
</p>

<ul>
    <li><strong>Typed column storage</strong>: Columns with homogeneous types (all integers, all floats, all strings, or all datetimes) use specialized storage for performance.</li>
    <li><strong>Grid-level metadata</strong>: Optional dictionary attached to the entire grid.</li>
    <li><strong>Column-level metadata</strong>: Optional dictionary attached to each column.</li>
    <li><strong>Lazy row access</strong>: The <code>GridRow</code> type provides efficient row-by-row access without copying data.</li>
    <li><strong>Views</strong>: The <code>GridView</code> type represents a filtered subset of rows without copying data.</li>
</ul>

<h1 id="grid-literal-syntax">Literal Syntax <a class="section-link" href="#grid-literal-syntax" aria-label="Permalink">§</a> <a class="back-to-top" href="#grid-top">Back to top</a></h1>

<p>
Grids are created using the <code>{{</code> and <code>}}</code> delimiters.
</p>

<h2>Basic Grid</h2>

<pre>
<code><span class="mshellDOUBLE_LEFT_CURLY">{{</span>
   <span class="mshellLITERAL">name</span><span class="mshellCOMMA">,</span> <span class="mshellLITERAL">age</span><span class="mshellCOMMA">,</span> <span class="mshellLITERAL">city</span><span class="mshellEXECUTE">;</span>
   <span class="mshellSTRING">"Alice"</span><span class="mshellCOMMA">,</span> <span class="mshellINTEGER">30</span><span class="mshellCOMMA">,</span> <span class="mshellSTRING">"NYC"</span><span class="mshellEXECUTE">;</span>
   <span class="mshellSTRING">"Bob"</span><span class="mshellCOMMA">,</span> <span class="mshellINTEGER">25</span><span class="mshellCOMMA">,</span> <span class="mshellSTRING">"LA"</span><span class="mshellEXECUTE">;</span>
   <span class="mshellSTRING">"Carol"</span><span class="mshellCOMMA">,</span> <span class="mshellINTEGER">35</span><span class="mshellCOMMA">,</span> <span class="mshellSTRING">"Chicago"</span>
<span class="mshellDOUBLE_RIGHT_CURLY">}}</span></code>
</pre>

<p>Structure:</p>
<ul>
    <li>Column definitions come first (comma-separated names, terminated by <code>;</code>)</li>
    <li>Row data follows (comma-separated values, each row terminated by <code>;</code>)</li>
    <li>The trailing semicolon on the last row is optional</li>
</ul>

<h2>Empty Grid</h2>

<pre>
<code><span class="mshellDOUBLE_LEFT_CURLY">{{</span> <span class="mshellLITERAL">col1</span><span class="mshellCOMMA">,</span> <span class="mshellLITERAL">col2</span><span class="mshellEXECUTE">;</span> <span class="mshellDOUBLE_RIGHT_CURLY">}}</span>  <span class="mshellLINECOMMENT"># Grid with columns but no rows</span></code>
</pre>

<h1 id="grid-metadata">Metadata <a class="section-link" href="#grid-metadata" aria-label="Permalink">§</a> <a class="back-to-top" href="#grid-top">Back to top</a></h1>

<h2>Grid Metadata</h2>

<p>
Optional grid-level metadata is specified as a dictionary followed by <code>;</code> before the column definitions:
</p>

<pre>
<code><span class="mshellDOUBLE_LEFT_CURLY">{{</span>
   <span class="mshellLEFT_CURLY">{</span> <span class="mshellSTRING">"source"</span><span class="mshellCOLON">:</span> <span class="mshellSTRING">"sensors"</span><span class="mshellCOMMA">,</span> <span class="mshellSTRING">"version"</span><span class="mshellCOLON">:</span> <span class="mshellINTEGER">2</span> <span class="mshellRIGHT_CURLY">}</span><span class="mshellEXECUTE">;</span>
   <span class="mshellLITERAL">timestamp</span><span class="mshellCOMMA">,</span> <span class="mshellLITERAL">value</span><span class="mshellEXECUTE">;</span>
   <span class="mshellDATETIME">2024-01-01T10:00</span><span class="mshellCOMMA">,</span> <span class="mshellFLOAT">23.5</span><span class="mshellEXECUTE">;</span>
   <span class="mshellDATETIME">2024-01-01T11:00</span><span class="mshellCOMMA">,</span> <span class="mshellFLOAT">24.1</span>
<span class="mshellDOUBLE_RIGHT_CURLY">}}</span></code>
</pre>

<h2>Column Metadata</h2>

<p>
Each column can have optional metadata specified as a dictionary immediately after the column name:
</p>

<pre>
<code><span class="mshellDOUBLE_LEFT_CURLY">{{</span>
   <span class="mshellLITERAL">temperature</span> <span class="mshellLEFT_CURLY">{</span> <span class="mshellSTRING">"unit"</span><span class="mshellCOLON">:</span> <span class="mshellSTRING">"celsius"</span> <span class="mshellRIGHT_CURLY">}</span><span class="mshellCOMMA">,</span> <span class="mshellLITERAL">humidity</span> <span class="mshellLEFT_CURLY">{</span> <span class="mshellSTRING">"unit"</span><span class="mshellCOLON">:</span> <span class="mshellSTRING">"percent"</span> <span class="mshellRIGHT_CURLY">}</span><span class="mshellEXECUTE">;</span>
   <span class="mshellFLOAT">23.5</span><span class="mshellCOMMA">,</span> <span class="mshellFLOAT">65.0</span><span class="mshellEXECUTE">;</span>
   <span class="mshellFLOAT">24.1</span><span class="mshellCOMMA">,</span> <span class="mshellFLOAT">62.5</span>
<span class="mshellDOUBLE_RIGHT_CURLY">}}</span></code>
</pre>

<h1 id="grid-operations">Grid Operations <a class="section-link" href="#grid-operations" aria-label="Permalink">§</a> <a class="back-to-top" href="#grid-top">Back to top</a></h1>

<table class="function-table">
    <thead>
        <tr> <th>Name</th> <th>Description</th> <th>Signature</th> </tr>
    </thead>
    <tbody>
        <tr id="func-gridRows">
            <td><code>gridRows</code></td>
            <td>Get the number of rows in a Grid or GridView.</td>
            <td><code>(Grid|GridView -- <span class="sig-type sig-type-int">int</span>)</code></td>
        </tr>
        <tr id="func-gridCols">
            <td><code>gridCols</code></td>
            <td>Get the list of column names from a Grid or GridView.</td>
            <td><code>(Grid|GridView -- [<span class="sig-type sig-type-str">str</span>])</code></td>
        </tr>
        <tr id="func-gridMeta">
            <td><code>gridMeta</code></td>
            <td>Get the grid-level metadata dictionary. Returns <code>none</code> if no metadata.</td>
            <td><code>(Grid|GridView -- <span class="sig-type sig-type-maybe">Maybe</span>[<span class="sig-type sig-type-dict">dict</span>])</code></td>
        </tr>
        <tr id="func-gridColMeta">
            <td><code>gridColMeta</code></td>
            <td>Get the metadata dictionary for a specific column. Returns <code>none</code> if no metadata.</td>
            <td><code>(Grid|GridView <span class="sig-type sig-type-str">str</span>:colname -- <span class="sig-type sig-type-maybe">Maybe</span>[<span class="sig-type sig-type-dict">dict</span>])</code></td>
        </tr>
        <tr id="func-gridCol">
            <td><code>gridCol</code></td>
            <td>Extract a single column as a list of values.</td>
            <td><code>(Grid|GridView <span class="sig-type sig-type-str">str</span>:colname -- [a])</code></td>
        </tr>
        <tr id="func-gridSetCell">
            <td><code>gridSetCell</code></td>
            <td>Set a single cell value. Returns the modified grid.</td>
            <td><code>(Grid <span class="sig-type sig-type-str">str</span>:colname <span class="sig-type sig-type-int">int</span>:rowIdx value -- Grid)</code></td>
        </tr>
        <tr id="func-gridAddCol">
            <td><code>gridAddCol</code></td>
            <td>Add a new column to a grid. The third argument can be a list of values (must match row count) or a default value for all rows.</td>
            <td><code>(Grid <span class="sig-type sig-type-str">str</span>:colname [values]|default -- Grid)</code></td>
        </tr>
        <tr id="func-gridRemoveCol">
            <td><code>gridRemoveCol</code></td>
            <td>Remove a column from a grid by name.</td>
            <td><code>(Grid <span class="sig-type sig-type-str">str</span>:colname -- Grid)</code></td>
        </tr>
        <tr id="func-gridRenameCol">
            <td><code>gridRenameCol</code></td>
            <td>Rename a column in a grid.</td>
            <td><code>(Grid <span class="sig-type sig-type-str">str</span>:oldname <span class="sig-type sig-type-str">str</span>:newname -- Grid)</code></td>
        </tr>
        <tr id="func-gridCompact">
            <td><code>gridCompact</code></td>
            <td>Materialize a GridView into a real Grid (copies the filtered rows). If already a Grid, returns it unchanged.</td>
            <td><code>(Grid|GridView -- Grid)</code></td>
        </tr>
        <tr id="func-len-grid">
            <td><code>len</code></td>
            <td>Returns the number of rows in a Grid, GridView, or columns in a GridRow.</td>
            <td><code>(Grid|GridView|GridRow -- <span class="sig-type sig-type-int">int</span>)</code></td>
        </tr>
    </tbody>
</table>

<h2>Examples</h2>

<pre>
<code><span class="mshellLINECOMMENT"># Create a grid</span>
<span class="mshellDOUBLE_LEFT_CURLY">{{</span> <span class="mshellLITERAL">x</span><span class="mshellCOMMA">,</span> <span class="mshellLITERAL">y</span><span class="mshellEXECUTE">;</span> <span class="mshellINTEGER">1</span><span class="mshellCOMMA">,</span> <span class="mshellINTEGER">2</span><span class="mshellEXECUTE">;</span> <span class="mshellINTEGER">3</span><span class="mshellCOMMA">,</span> <span class="mshellINTEGER">4</span> <span class="mshellDOUBLE_RIGHT_CURLY">}}</span> <span class="mshellVARSTORE">grid!</span>

<span class="mshellLINECOMMENT"># Get row count</span>
<span class="mshellVARRETRIEVE">@grid</span> <span class="mshellLITERAL">gridRows</span>  <span class="mshellLINECOMMENT"># 2</span>

<span class="mshellLINECOMMENT"># Get column names</span>
<span class="mshellVARRETRIEVE">@grid</span> <span class="mshellLITERAL">gridCols</span>  <span class="mshellLINECOMMENT"># ["x" "y"]</span>

<span class="mshellLINECOMMENT"># Extract a column</span>
<span class="mshellVARRETRIEVE">@grid</span> <span class="mshellSTRING">"x"</span> <span class="mshellLITERAL">gridCol</span>  <span class="mshellLINECOMMENT"># [1 3]</span>

<span class="mshellLINECOMMENT"># Add a new column</span>
<span class="mshellVARRETRIEVE">@grid</span> <span class="mshellSTRING">"z"</span> <span class="mshellLEFT_SQUARE_BRACKET">[</span><span class="mshellINTEGER">10</span> <span class="mshellINTEGER">20</span><span class="mshellRIGHT_SQUARE_BRACKET">]</span> <span class="mshellLITERAL">gridAddCol</span>  <span class="mshellLINECOMMENT"># Grid with x, y, z columns</span>

<span class="mshellLINECOMMENT"># Set a cell value</span>
<span class="mshellVARRETRIEVE">@grid</span> <span class="mshellSTRING">"x"</span> <span class="mshellINTEGER">0</span> <span class="mshellINTEGER">100</span> <span class="mshellLITERAL">gridSetCell</span>  <span class="mshellLINECOMMENT"># Sets grid[0]["x"] = 100</span></code>
</pre>

<h1 id="grid-view">GridView <a class="section-link" href="#grid-view" aria-label="Permalink">§</a> <a class="back-to-top" href="#grid-top">Back to top</a></h1>

<p>
A <code>GridView</code> is a filtered view of a Grid that references the original data without copying.
It maintains a list of row indices that match the filter criteria.
</p>

<p>
GridViews are created by the <code>gridFilter</code> operation and can be used in most places where a Grid is expected.
To materialize a GridView into a real Grid (with copied data), use <code>gridCompact</code>.
</p>

<pre>
<code><span class="mshellLINECOMMENT"># Filter creates a GridView</span>
<span class="mshellDOUBLE_LEFT_CURLY">{{</span> <span class="mshellLITERAL">x</span><span class="mshellEXECUTE">;</span> <span class="mshellINTEGER">1</span><span class="mshellEXECUTE">;</span> <span class="mshellINTEGER">2</span><span class="mshellEXECUTE">;</span> <span class="mshellINTEGER">3</span><span class="mshellEXECUTE">;</span> <span class="mshellINTEGER">4</span> <span class="mshellDOUBLE_RIGHT_CURLY">}}</span> <span class="mshellLEFT_PAREN">(</span><span class="mshellCOLON">:</span><span class="mshellLITERAL">x</span> <span class="mshellINTEGER">2</span> <span class="mshellGREATERTHAN">></span><span class="mshellRIGHT_PAREN">)</span> <span class="mshellLITERAL">gridFilter</span>  <span class="mshellLINECOMMENT"># GridView with rows where x > 2</span>

<span class="mshellLINECOMMENT"># Materialize to a Grid</span>
<span class="mshellLITERAL">gridCompact</span>  <span class="mshellLINECOMMENT"># Now a real Grid with copied data</span></code>
</pre>

<h1 id="grid-row">GridRow <a class="section-link" href="#grid-row" aria-label="Permalink">§</a> <a class="back-to-top" href="#grid-top">Back to top</a></h1>

<p>
A <code>GridRow</code> is a lazy reference to a single row in a Grid.
It does not copy data; instead, it stores a reference to the parent grid and a row index.
This makes iteration over grids very efficient.
</p>

<p>
GridRows support dictionary-like access:
</p>

<ul>
    <li><code>:colname</code> getter syntax returns the value at that column</li>
    <li><code>get</code> operation works with string keys</li>
    <li><code>toDict</code> materializes the row to an actual dictionary</li>
</ul>

<pre>
<code><span class="mshellDOUBLE_LEFT_CURLY">{{</span> <span class="mshellLITERAL">name</span><span class="mshellCOMMA">,</span> <span class="mshellLITERAL">age</span><span class="mshellEXECUTE">;</span> <span class="mshellSTRING">"Alice"</span><span class="mshellCOMMA">,</span> <span class="mshellINTEGER">30</span> <span class="mshellDOUBLE_RIGHT_CURLY">}}</span> <span class="mshellVARSTORE">grid!</span>

<span class="mshellLINECOMMENT"># Access first row</span>
<span class="mshellVARRETRIEVE">@grid</span> <span class="mshellINDEXER">:0:</span>  <span class="mshellLINECOMMENT"># GridRow for first row</span>

<span class="mshellLINECOMMENT"># Get column value from GridRow</span>
<span class="mshellCOLON">:</span><span class="mshellLITERAL">name</span>  <span class="mshellLINECOMMENT"># "Alice"</span>

<span class="mshellLINECOMMENT"># Or use get</span>
<span class="mshellVARRETRIEVE">@grid</span> <span class="mshellINDEXER">:0:</span> <span class="mshellSTRING">"age"</span> <span class="mshellLITERAL">get</span><span class="mshellQUESTION">?</span>  <span class="mshellLINECOMMENT"># 30</span>

<span class="mshellLINECOMMENT"># Convert to dict</span>
<span class="mshellVARRETRIEVE">@grid</span> <span class="mshellINDEXER">:0:</span> <span class="mshellLITERAL">toDict</span>  <span class="mshellLINECOMMENT"># {"age": 30, "name": "Alice"}</span></code>
</pre>

<h1 id="grid-iteration">Iteration Operations <a class="section-link" href="#grid-iteration" aria-label="Permalink">§</a> <a class="back-to-top" href="#grid-top">Back to top</a></h1>

<table class="function-table">
    <thead>
        <tr> <th>Name</th> <th>Description</th> <th>Signature</th> </tr>
    </thead>
    <tbody>
        <tr id="func-gridFilter">
            <td><code>gridFilter</code></td>
            <td>Filter rows using a predicate quotation. The quotation receives a GridRow and should return a boolean. Returns a GridView (no data copying).</td>
            <td><code>(Grid|GridView (<span class="sig-type sig-type-gridrow">GridRow</span> -- <span class="sig-type sig-type-bool">bool</span>) -- GridView)</code></td>
        </tr>
        <tr id="func-gridMap">
            <td><code>gridMap</code></td>
            <td>Transform rows using a quotation. The quotation receives a GridRow and should return a GridRow or dict. Returns a new Grid.</td>
            <td><code>(Grid|GridView (<span class="sig-type sig-type-gridrow">GridRow</span> -- <span class="sig-type sig-type-gridrow">GridRow</span>|<span class="sig-type sig-type-dict">dict</span>) -- Grid)</code></td>
        </tr>
        <tr id="func-gridEach">
            <td><code>gridEach</code></td>
            <td>Iterate over rows for side effects. The quotation receives a GridRow.</td>
            <td><code>(Grid|GridView (<span class="sig-type sig-type-gridrow">GridRow</span> -- ) -- )</code></td>
        </tr>
        <tr id="func-toDict">
            <td><code>toDict</code></td>
            <td>Convert a GridRow to a dictionary.</td>
            <td><code>(<span class="sig-type sig-type-gridrow">GridRow</span> -- <span class="sig-type sig-type-dict">dict</span>)</code></td>
        </tr>
    </tbody>
</table>

<h2>Examples</h2>

<pre>
<code><span class="mshellDOUBLE_LEFT_CURLY">{{</span>
   <span class="mshellLITERAL">name</span><span class="mshellCOMMA">,</span> <span class="mshellLITERAL">score</span><span class="mshellEXECUTE">;</span>
   <span class="mshellSTRING">"Alice"</span><span class="mshellCOMMA">,</span> <span class="mshellINTEGER">85</span><span class="mshellEXECUTE">;</span>
   <span class="mshellSTRING">"Bob"</span><span class="mshellCOMMA">,</span> <span class="mshellINTEGER">92</span><span class="mshellEXECUTE">;</span>
   <span class="mshellSTRING">"Carol"</span><span class="mshellCOMMA">,</span> <span class="mshellINTEGER">78</span>
<span class="mshellDOUBLE_RIGHT_CURLY">}}</span> <span class="mshellVARSTORE">students!</span>

<span class="mshellLINECOMMENT"># Filter: students with score >= 80</span>
<span class="mshellVARRETRIEVE">@students</span> <span class="mshellLEFT_PAREN">(</span><span class="mshellCOLON">:</span><span class="mshellLITERAL">score</span> <span class="mshellINTEGER">80</span> <span class="mshellGREATERTHANOREQUAL">>=</span><span class="mshellRIGHT_PAREN">)</span> <span class="mshellLITERAL">gridFilter</span>
<span class="mshellLINECOMMENT"># GridView with Alice and Bob</span>

<span class="mshellLINECOMMENT"># Map: add a "passed" column</span>
<span class="mshellVARRETRIEVE">@students</span> <span class="mshellLEFT_PAREN">(</span>
   <span class="mshellLITERAL">toDict</span>
   <span class="mshellLITERAL">dup</span> <span class="mshellSTRING">"score"</span> <span class="mshellLITERAL">get</span><span class="mshellQUESTION">?</span> <span class="mshellINTEGER">70</span> <span class="mshellGREATERTHANOREQUAL">>=</span> <span class="mshellSTRING">"passed"</span> <span class="mshellLITERAL">set</span>
<span class="mshellRIGHT_PAREN">)</span> <span class="mshellLITERAL">gridMap</span>

<span class="mshellLINECOMMENT"># Each: print each student's name</span>
<span class="mshellVARRETRIEVE">@students</span> <span class="mshellLEFT_PAREN">(</span><span class="mshellCOLON">:</span><span class="mshellLITERAL">name</span> <span class="mshellLITERAL">wl</span><span class="mshellRIGHT_PAREN">)</span> <span class="mshellLITERAL">gridEach</span>
<span class="mshellLINECOMMENT"># Prints: Alice, Bob, Carol (one per line)</span></code>
</pre>

<h1 id="grid-json">JSON Serialization <a class="section-link" href="#grid-json" aria-label="Permalink">§</a> <a class="back-to-top" href="#grid-top">Back to top</a></h1>

<p>
Grids serialize to JSON as an array of row objects:
</p>

<pre>
<code><span class="mshellDOUBLE_LEFT_CURLY">{{</span> <span class="mshellLITERAL">x</span><span class="mshellCOMMA">,</span> <span class="mshellLITERAL">y</span><span class="mshellEXECUTE">;</span> <span class="mshellINTEGER">1</span><span class="mshellCOMMA">,</span> <span class="mshellINTEGER">2</span><span class="mshellEXECUTE">;</span> <span class="mshellINTEGER">3</span><span class="mshellCOMMA">,</span> <span class="mshellINTEGER">4</span> <span class="mshellDOUBLE_RIGHT_CURLY">}}</span> <span class="mshellLITERAL">toJson</span>
<span class="mshellLINECOMMENT"># [{"x": 1, "y": 2}, {"x": 3, "y": 4}]</span></code>
</pre>

<p>
GridRows also serialize as JSON objects:
</p>

<pre>
<code><span class="mshellDOUBLE_LEFT_CURLY">{{</span> <span class="mshellLITERAL">x</span><span class="mshellCOMMA">,</span> <span class="mshellLITERAL">y</span><span class="mshellEXECUTE">;</span> <span class="mshellINTEGER">1</span><span class="mshellCOMMA">,</span> <span class="mshellINTEGER">2</span> <span class="mshellDOUBLE_RIGHT_CURLY">}}</span> <span class="mshellINDEXER">:0:</span> <span class="mshellLITERAL">toJson</span>
<span class="mshellLINECOMMENT"># {"x": 1, "y": 2}</span></code>
</pre>
